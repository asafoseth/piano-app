<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Feedback Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .feedback-buttons { display: flex; gap: 20px; margin: 20px 0; }
        .feedback-btn { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .like-btn { background: #4CAF50; color: white; }
        .dislike-btn { background: #f44336; color: white; }
        .feedback-btn:hover { transform: translateY(-2px); }
        .feedback-btn.clicked { transform: scale(0.95); box-shadow: inset 0 2px 8px rgba(0,0,0,0.3); }
        .feedback-btn.loading { opacity: 0.7; cursor: not-allowed; }
        .count { background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 20px; font-weight: bold; }
        .console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; margin: 20px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üéπ Fixed Feedback System Test</h1>
    <p>This test verifies that anonymous users can now update the Firebase database.</p>
    
    <div class="feedback-buttons">
        <button id="like-btn" class="feedback-btn like-btn">
            üëç Like
            <span id="like-count" class="count">0</span>
        </button>
        <button id="dislike-btn" class="feedback-btn dislike-btn">
            üëé Dislike
            <span id="dislike-count" class="count">0</span>
        </button>
    </div>
    
    <p id="feedback-message" style="margin: 20px 0; font-weight: bold;"></p>
    
    <div id="status"></div>
    
    <h3>Console Output:</h3>
    <div id="console" class="console">Initializing...\n</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const consoleDiv = document.getElementById('console');
            const statusDiv = document.getElementById('status');
            
            consoleDiv.textContent += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            // Show status message
            if (type !== 'info') {
                const statusEl = document.createElement('div');
                statusEl.className = `status ${type}`;
                statusEl.textContent = message;
                statusDiv.appendChild(statusEl);
                setTimeout(() => statusEl.remove(), 5000);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDITrrDnAKRWjgQnpwfcyGKdUgjkI4ogA8",
            authDomain: "ali-piano.firebaseapp.com",
            projectId: "ali-piano",
            storageBucket: "ali-piano.firebasestorage.app",
            messagingSenderId: "806442476961",
            appId: "1:806442476961:web:365f1a133a33f0ed69d7e0",
            measurementId: "G-6NG4N6WK95"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            log('‚úÖ Firebase initialized successfully', 'success');

            // Fixed PianoFeedback class (no authentication check)
            class FixedPianoFeedback {
                constructor() {
                    this.feedbackDoc = 'pianoFeedback';
                    this.realtimeListener = null;
                    log('üéπ FixedPianoFeedback constructor called');
                    this.init();
                }

                async init() {
                    log('üîß Starting initialization...');
                    try {
                        await this.loadFeedbackCounts();
                        this.setupEventListeners();
                        this.setupRealtimeListener();
                        this.checkUserVoteStatus();
                        log('‚úÖ FixedPianoFeedback initialized successfully', 'success');
                    } catch (error) {
                        log(`‚ùå Initialization failed: ${error.message}`, 'error');
                    }
                }

                async loadFeedbackCounts() {
                    try {
                        log('üì• Loading feedback counts from Firestore...');
                        const docRef = doc(db, 'feedback', this.feedbackDoc);
                        const docSnap = await getDoc(docRef);
                        
                        let likes = 0;
                        let dislikes = 0;

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            likes = data.likes || 0;
                            dislikes = data.dislikes || 0;
                            log(`‚úÖ Loaded from Firebase: ${likes} likes, ${dislikes} dislikes`, 'success');
                        } else {
                            log('‚ö†Ô∏è Document does not exist, creating initial document', 'warning');
                            const initialData = {
                                likes: 0,
                                dislikes: 0,
                                created: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            };
                            await setDoc(docRef, initialData);
                            log('üìÑ Initial document created', 'success');
                        }

                        this.updateCountDisplay(likes, dislikes);
                        
                    } catch (error) {
                        log(`‚ùå Error loading feedback counts: ${error.code} - ${error.message}`, 'error');
                        const likes = parseInt(localStorage.getItem('piano_likes_count') || '0');
                        const dislikes = parseInt(localStorage.getItem('piano_dislikes_count') || '0');
                        this.updateCountDisplay(likes, dislikes);
                        log(`üì± Using localStorage fallback: ${likes} likes, ${dislikes} dislikes`, 'warning');
                    }
                }

                setupEventListeners() {
                    const likeBtn = document.getElementById('like-btn');
                    const dislikeBtn = document.getElementById('dislike-btn');

                    if (likeBtn) {
                        likeBtn.addEventListener('click', () => {
                            log('üëç Like button clicked');
                            this.handleVote('like');
                        });
                    }

                    if (dislikeBtn) {
                        dislikeBtn.addEventListener('click', () => {
                            log('üëé Dislike button clicked');
                            this.handleVote('dislike');
                        });
                    }
                }

                setupRealtimeListener() {
                    try {
                        const docRef = doc(db, 'feedback', this.feedbackDoc);
                        this.realtimeListener = onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const likes = data.likes || 0;
                                const dislikes = data.dislikes || 0;
                                log(`üåç Real-time update: ${likes} likes, ${dislikes} dislikes`);
                                this.updateCountDisplay(likes, dislikes);
                            }
                        }, (error) => {
                            log(`‚ùå Real-time listener error: ${error.message}`, 'error');
                        });
                        log('‚úÖ Real-time listener setup complete', 'success');
                    } catch (error) {
                        log(`‚ùå Failed to setup real-time listener: ${error.message}`, 'error');
                    }
                }

                async handleVote(voteType) {
                    log(`üó≥Ô∏è Handling vote: ${voteType}`);
                    
                    const btn = document.getElementById(`${voteType}-btn`);
                    if (!btn) {
                        log(`‚ùå Button not found: ${voteType}-btn`, 'error');
                        return;
                    }

                    btn.classList.add('loading');

                    try {
                        const currentVote = this.getUserCurrentVote();
                        let action = 'none';
                        if (currentVote === null) {
                            action = 'add';
                        } else if (currentVote === voteType) {
                            action = 'remove';
                        } else {
                            action = 'switch';
                        }
                        
                        log(`üéØ Vote action: ${action}`);

                        // NO AUTHENTICATION CHECK - Allow anonymous users
                        log('üîÑ Updating Firestore (anonymous access allowed)...');
                        await this.updateFirestoreCountWithAction(voteType, action);
                        log('‚úÖ Firestore update successful', 'success');
                        
                        this.setUserVote(action === 'remove' ? null : voteType);
                        this.updateButtonStates(voteType, action, btn, null);
                        
                    } catch (error) {
                        log(`‚ùå Vote handling failed: ${error.code} - ${error.message}`, 'error');
                        this.showMessage(`‚ùå Error: ${error.message || 'Unknown error occurred'}`);
                    } finally {
                        btn.classList.remove('loading');
                    }
                }

                async updateFirestoreCountWithAction(voteType, action) {
                    const docRef = doc(db, 'feedback', this.feedbackDoc);
                    
                    try {
                        const docSnap = await getDoc(docRef);
                        
                        let currentLikes = 0;
                        let currentDislikes = 0;

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            currentLikes = data.likes || 0;
                            currentDislikes = data.dislikes || 0;
                        }

                        let newLikes = currentLikes;
                        let newDislikes = currentDislikes;
                        
                        if (action === 'add') {
                            if (voteType === 'like') {
                                newLikes++;
                            } else {
                                newDislikes++;
                            }
                        } else if (action === 'remove') {
                            if (voteType === 'like') {
                                newLikes = Math.max(0, newLikes - 1);
                            } else {
                                newDislikes = Math.max(0, newDislikes - 1);
                            }
                        } else if (action === 'switch') {
                            if (voteType === 'like') {
                                newLikes++;
                                newDislikes = Math.max(0, newDislikes - 1);
                            } else {
                                newDislikes++;
                                newLikes = Math.max(0, newLikes - 1);
                            }
                        }

                        const timestamp = new Date().toISOString();
                        const newData = {
                            likes: newLikes,
                            dislikes: newDislikes,
                            lastUpdated: timestamp,
                            lastAction: `${action}_${voteType}`,
                            totalVotes: newLikes + newDislikes,
                            ...(docSnap.exists() ? {} : { created: timestamp })
                        };
                        
                        log(`üíæ Saving data: ${JSON.stringify(newData)}`);
                        await setDoc(docRef, newData);
                        log(`‚úÖ Document updated! New counts - Likes: ${newLikes}, Dislikes: ${newDislikes}`, 'success');
                        
                    } catch (error) {
                        log(`‚ùå updateFirestoreCountWithAction error: ${error.code} - ${error.message}`, 'error');
                        throw error;
                    }
                }

                updateCountDisplay(likes, dislikes) {
                    const likeCount = document.getElementById('like-count');
                    const dislikeCount = document.getElementById('dislike-count');

                    if (likeCount) likeCount.textContent = likes;
                    if (dislikeCount) dislikeCount.textContent = dislikes;
                    
                    log(`üìä Display updated: ${likes} likes, ${dislikes} dislikes`);
                }

                getUserCurrentVote() {
                    return localStorage.getItem('piano_user_vote');
                }

                setUserVote(voteType) {
                    if (voteType === null) {
                        localStorage.removeItem('piano_user_vote');
                    } else {
                        localStorage.setItem('piano_user_vote', voteType);
                    }
                }

                updateButtonStates(voteType, action, btn, oppositeBtn) {
                    if (action === 'add' || action === 'switch') {
                        btn.classList.add('clicked');
                    } else if (action === 'remove') {
                        btn.classList.remove('clicked');
                    }
                }

                checkUserVoteStatus() {
                    const likeBtn = document.getElementById('like-btn');
                    const dislikeBtn = document.getElementById('dislike-btn');
                    const currentVote = this.getUserCurrentVote();

                    if (likeBtn) likeBtn.classList.remove('clicked');
                    if (dislikeBtn) dislikeBtn.classList.remove('clicked');

                    if (currentVote === 'like' && likeBtn) {
                        likeBtn.classList.add('clicked');
                    } else if (currentVote === 'dislike' && dislikeBtn) {
                        dislikeBtn.classList.add('clicked');
                    }
                }

                showMessage(message) {
                    const messageEl = document.getElementById('feedback-message');
                    if (messageEl) {
                        messageEl.textContent = message;
                        setTimeout(() => messageEl.textContent = '', 3000);
                    }
                }
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', () => {
                log('üìÑ DOM loaded - initializing fixed feedback system...');
                window.pianoFeedbackInstance = new FixedPianoFeedback();
            });

            // Auth state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    log(`üë§ User logged in: ${user.email || user.displayName}`, 'success');
                } else {
                    log('üë§ Anonymous user - Firebase access should still work', 'warning');
                }
            });

        } catch (error) {
            log(`‚ùå Critical error: ${error.message}`, 'error');
        }
    </script>
</body>
</html>