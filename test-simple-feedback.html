<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Feedback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .feedback-buttons {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .feedback-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .like-btn {
            background: #4CAF50;
            color: white;
        }
        .dislike-btn {
            background: #f44336;
            color: white;
        }
        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .feedback-btn.clicked {
            transform: scale(0.95);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }
        .feedback-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .count {
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <h1>üéπ Piano Feedback System Test</h1>
    
    <div class="feedback-buttons">
        <button id="like-btn" class="feedback-btn like-btn">
            üëç Like
            <span id="like-count" class="count">0</span>
        </button>
        <button id="dislike-btn" class="feedback-btn dislike-btn">
            üëé Dislike
            <span id="dislike-count" class="count">0</span>
        </button>
    </div>
    
    <p id="feedback-message" style="margin: 20px 0; font-weight: bold;"></p>
    
    <h3>Console Output:</h3>
    <div id="console" class="console">Initializing...\n</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // Console logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const consoleDiv = document.getElementById('console');
            const className = type;
            consoleDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDITrrDnAKRWjgQnpwfcyGKdUgjkI4ogA8",
            authDomain: "ali-piano.firebaseapp.com",
            projectId: "ali-piano",
            storageBucket: "ali-piano.firebasestorage.app",
            messagingSenderId: "806442476961",
            appId: "1:806442476961:web:365f1a133a33f0ed69d7e0",
            measurementId: "G-6NG4N6WK95"
        };

        try {
            log('üöÄ Initializing Firebase...', 'info');
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            log('‚úÖ Firebase initialized successfully', 'success');

            // Simplified PianoFeedback class
            class PianoFeedback {
                constructor() {
                    this.feedbackDoc = 'pianoFeedback';
                    this.realtimeListener = null;
                    log('üéπ PianoFeedback constructor called', 'info');
                    this.init();
                }

                async init() {
                    log('üîß Starting PianoFeedback initialization...', 'info');
                    
                    try {
                        // Load initial counts
                        await this.loadFeedbackCounts();
                        
                        // Setup event listeners
                        this.setupEventListeners();
                        
                        // Setup real-time listener
                        this.setupRealtimeListener();
                        
                        // Check user vote status
                        this.checkUserVoteStatus();
                        
                        log('‚úÖ PianoFeedback initialized successfully', 'success');
                    } catch (error) {
                        log(`‚ùå PianoFeedback initialization failed: ${error.message}`, 'error');
                    }
                }

                async loadFeedbackCounts() {
                    try {
                        log('üì• Loading feedback counts from Firestore...', 'info');
                        const docRef = doc(db, 'feedback', this.feedbackDoc);
                        const docSnap = await getDoc(docRef);
                        
                        let likes = 0;
                        let dislikes = 0;

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            log(`üìä Document data: ${JSON.stringify(data)}`, 'info');
                            likes = data.likes || 0;
                            dislikes = data.dislikes || 0;
                            log(`‚úÖ Loaded from Firebase: ${likes} likes, ${dislikes} dislikes`, 'success');
                        } else {
                            log('‚ö†Ô∏è Document does not exist, will create with initial values', 'warning');
                            // Create initial document
                            const initialData = {
                                likes: 0,
                                dislikes: 0,
                                created: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            };
                            await setDoc(docRef, initialData);
                            log('üìÑ Initial document created', 'success');
                        }

                        this.updateCountDisplay(likes, dislikes);
                        
                    } catch (error) {
                        log(`‚ùå Error loading feedback counts: ${error.code} - ${error.message}`, 'error');
                        // Fallback to localStorage
                        const likes = parseInt(localStorage.getItem('piano_likes_count') || '0');
                        const dislikes = parseInt(localStorage.getItem('piano_dislikes_count') || '0');
                        this.updateCountDisplay(likes, dislikes);
                        log(`üì± Using localStorage fallback: ${likes} likes, ${dislikes} dislikes`, 'warning');
                    }
                }

                setupEventListeners() {
                    log('üéØ Setting up event listeners...', 'info');
                    
                    const likeBtn = document.getElementById('like-btn');
                    const dislikeBtn = document.getElementById('dislike-btn');

                    if (likeBtn) {
                        likeBtn.addEventListener('click', () => {
                            log('üëç Like button clicked', 'info');
                            this.handleVote('like');
                        });
                        log('‚úÖ Like button listener attached', 'success');
                    } else {
                        log('‚ùå Like button not found', 'error');
                    }

                    if (dislikeBtn) {
                        dislikeBtn.addEventListener('click', () => {
                            log('üëé Dislike button clicked', 'info');
                            this.handleVote('dislike');
                        });
                        log('‚úÖ Dislike button listener attached', 'success');
                    } else {
                        log('‚ùå Dislike button not found', 'error');
                    }
                }

                setupRealtimeListener() {
                    log('üåê Setting up real-time listener...', 'info');
                    
                    try {
                        const docRef = doc(db, 'feedback', this.feedbackDoc);
                        
                        this.realtimeListener = onSnapshot(docRef, (docSnap) => {
                            log('üîÑ Real-time update received', 'info');
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const likes = data.likes || 0;
                                const dislikes = data.dislikes || 0;
                                log(`üåç Real-time data: ${likes} likes, ${dislikes} dislikes`, 'success');
                                this.updateCountDisplay(likes, dislikes);
                            }
                        }, (error) => {
                            log(`‚ùå Real-time listener error: ${error.message}`, 'error');
                        });
                        
                        log('‚úÖ Real-time listener setup complete', 'success');
                    } catch (error) {
                        log(`‚ùå Failed to setup real-time listener: ${error.message}`, 'error');
                    }
                }

                async handleVote(voteType) {
                    log(`üó≥Ô∏è Handling vote: ${voteType}`, 'info');
                    
                    const btn = document.getElementById(`${voteType}-btn`);
                    const oppositeType = voteType === 'like' ? 'dislike' : 'like';
                    const oppositeBtn = document.getElementById(`${oppositeType}-btn`);
                    
                    if (!btn) {
                        log(`‚ùå Button not found: ${voteType}-btn`, 'error');
                        return;
                    }

                    // Add loading state
                    btn.classList.add('loading');
                    log(`‚è≥ Added loading state to ${voteType} button`, 'info');

                    try {
                        const currentVote = this.getUserCurrentVote();
                        log(`üìä Current user vote: ${currentVote}`, 'info');
                        
                        // Determine the action to take
                        let action = 'none';
                        if (currentVote === null) {
                            action = 'add';
                        } else if (currentVote === voteType) {
                            action = 'remove';
                        } else {
                            action = 'switch';
                        }
                        
                        log(`üéØ Vote action determined: ${action}`, 'info');

                        // Update Firestore
                        await this.updateFirestoreCountWithAction(voteType, action);
                        log('‚úÖ Firestore update successful', 'success');
                        
                        // Update user's vote preference
                        this.setUserVote(action === 'remove' ? null : voteType);
                        log(`üíæ User vote preference updated: ${action === 'remove' ? null : voteType}`, 'info');
                        
                        // Update UI
                        this.updateButtonStates(voteType, action, btn, oppositeBtn);
                        log('üé® UI state updated', 'info');
                        
                    } catch (error) {
                        log(`‚ùå Vote handling failed: ${error.code} - ${error.message}`, 'error');
                        
                        // Show user-friendly error
                        this.showMessage(`‚ùå Error: ${error.message || 'Unknown error occurred'}`);
                    } finally {
                        btn.classList.remove('loading');
                        log(`‚úÖ Removed loading state from ${voteType} button`, 'info');
                    }
                }

                async updateFirestoreCountWithAction(voteType, action) {
                    log(`üîÑ updateFirestoreCountWithAction called: ${voteType}, ${action}`, 'info');
                    
                    const docRef = doc(db, 'feedback', this.feedbackDoc);
                    log('üìÑ Document reference created', 'info');
                    
                    try {
                        // Get current counts
                        log('üì• Getting current document...', 'info');
                        const docSnap = await getDoc(docRef);
                        log(`üìä Document exists: ${docSnap.exists()}`, 'info');
                        
                        let currentLikes = 0;
                        let currentDislikes = 0;

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            log(`üìä Current document data: ${JSON.stringify(data)}`, 'info');
                            currentLikes = data.likes || 0;
                            currentDislikes = data.dislikes || 0;
                        }

                        let newLikes = currentLikes;
                        let newDislikes = currentDislikes;
                        
                        // Apply the action
                        if (action === 'add') {
                            if (voteType === 'like') {
                                newLikes++;
                            } else {
                                newDislikes++;
                            }
                        } else if (action === 'remove') {
                            if (voteType === 'like') {
                                newLikes = Math.max(0, newLikes - 1);
                            } else {
                                newDislikes = Math.max(0, newDislikes - 1);
                            }
                        } else if (action === 'switch') {
                            if (voteType === 'like') {
                                newLikes++;
                                newDislikes = Math.max(0, newDislikes - 1);
                            } else {
                                newDislikes++;
                                newLikes = Math.max(0, newLikes - 1);
                            }
                        }

                        // Prepare new data
                        const timestamp = new Date().toISOString();
                        const newData = {
                            likes: newLikes,
                            dislikes: newDislikes,
                            lastUpdated: timestamp,
                            lastAction: `${action}_${voteType}`,
                            lastVoteType: voteType,
                            lastVoteAction: action,
                            totalVotes: newLikes + newDislikes,
                            lastVoteTimestamp: timestamp,
                            ...(docSnap.exists() ? {} : { 
                                created: timestamp,
                                firstVoteTimestamp: timestamp 
                            })
                        };
                        
                        log(`üíæ New data to save: ${JSON.stringify(newData)}`, 'info');
                        log('üîÑ Setting document...', 'info');
                        
                        await setDoc(docRef, newData);
                        
                        log(`‚úÖ Document updated successfully! New counts - Likes: ${newLikes}, Dislikes: ${newDislikes}`, 'success');
                        
                    } catch (error) {
                        log(`‚ùå updateFirestoreCountWithAction error: ${error.code} - ${error.message}`, 'error');
                        throw error;
                    }
                }

                updateCountDisplay(likes, dislikes) {
                    const likeCount = document.getElementById('like-count');
                    const dislikeCount = document.getElementById('dislike-count');

                    log(`üîÑ Updating display: ${likes} likes, ${dislikes} dislikes`, 'info');

                    if (likeCount) {
                        likeCount.textContent = likes;
                        log('‚úÖ Like count element updated', 'success');
                    } else {
                        log('‚ùå Like count element not found', 'error');
                    }
                    
                    if (dislikeCount) {
                        dislikeCount.textContent = dislikes;
                        log('‚úÖ Dislike count element updated', 'success');
                    } else {
                        log('‚ùå Dislike count element not found', 'error');
                    }
                    
                    const totalVotes = likes + dislikes;
                    log(`üìä Total votes: ${totalVotes}`, 'info');
                }

                getUserCurrentVote() {
                    const vote = localStorage.getItem('piano_user_vote');
                    log(`üë§ User current vote from localStorage: ${vote}`, 'info');
                    return vote;
                }

                setUserVote(voteType) {
                    if (voteType === null) {
                        localStorage.removeItem('piano_user_vote');
                        log('üóëÔ∏è User vote cleared from localStorage', 'info');
                    } else {
                        localStorage.setItem('piano_user_vote', voteType);
                        log(`üíæ User vote saved to localStorage: ${voteType}`, 'info');
                    }
                }

                updateButtonStates(voteType, action, btn, oppositeBtn) {
                    log(`üé® Updating button states: ${voteType}, ${action}`, 'info');
                    
                    btn.classList.remove('loading');
                    
                    if (action === 'add' || action === 'switch') {
                        btn.classList.add('clicked');
                        if (oppositeBtn) {
                            oppositeBtn.classList.remove('clicked');
                        }
                        log(`‚úÖ ${voteType} button activated`, 'success');
                    } else if (action === 'remove') {
                        btn.classList.remove('clicked');
                        log(`‚úÖ ${voteType} button deactivated`, 'success');
                    }
                }

                checkUserVoteStatus() {
                    log('üîç Checking user vote status...', 'info');
                    
                    const likeBtn = document.getElementById('like-btn');
                    const dislikeBtn = document.getElementById('dislike-btn');
                    const currentVote = this.getUserCurrentVote();

                    // Remove all clicked states first
                    if (likeBtn) likeBtn.classList.remove('clicked');
                    if (dislikeBtn) dislikeBtn.classList.remove('clicked');

                    // Apply the current vote state
                    if (currentVote === 'like' && likeBtn) {
                        likeBtn.classList.add('clicked');
                        log('üëç Like button state restored', 'info');
                    } else if (currentVote === 'dislike' && dislikeBtn) {
                        dislikeBtn.classList.add('clicked');
                        log('üëé Dislike button state restored', 'info');
                    }
                    
                    log('‚úÖ User vote status check complete', 'success');
                }

                showMessage(message) {
                    const messageEl = document.getElementById('feedback-message');
                    if (messageEl) {
                        messageEl.textContent = message;
                        log(`üí¨ Message shown to user: ${message}`, 'info');
                        
                        setTimeout(() => {
                            messageEl.textContent = '';
                        }, 3000);
                    }
                }
            }

            // Initialize PianoFeedback when DOM is ready
            document.addEventListener('DOMContentLoaded', () => {
                log('üìÑ DOM loaded - initializing PianoFeedback...', 'info');
                window.pianoFeedbackInstance = new PianoFeedback();
            });

            // Auth state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    log(`üë§ User logged in: ${user.email || user.displayName}`, 'success');
                } else {
                    log('üë§ User is anonymous', 'warning');
                }
            });

        } catch (error) {
            log(`‚ùå Critical error: ${error.message}`, 'error');
        }
    </script>
</body>
</html>