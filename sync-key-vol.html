<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing Key Audio Mixer</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif; /* Match app font */
            background: linear-gradient(to bottom right, #2c3e50, #4a5a70); /* Match app background */
            color: #e0e0e0; /* Match app text color */
            margin: 0;
            padding: 20px; /* Add padding */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-top: 0; /* Remove default top margin */
            margin-bottom: 30px; /* Add space below title */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); /* Match app title shadow */
        }

        .key-group {
            margin-bottom: 25px; /* Space between key groups */
            padding: 20px;
            background-color: rgba(36, 39, 46, 0.8); /* Slightly transparent background matching piano container */
            border-radius: 8px;
            width: 90%;
            max-width: 700px; /* Max width for readability */
            box-shadow: 0 10px 20px rgba(7, 0, 53, 0.25); /* Match app shadow style */
        }

        .key-group h2 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #5c6bc0; /* Accent color border */
            padding-bottom: 8px;
            color: #fff; /* Brighter header */
        }

        .audio-control {
            margin-bottom: 12px; /* Space between controls */
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: space-between;
            align-items: center;
            gap: 10px; /* Space between label, slider, value */
        }

        .audio-control label {
            flex-basis: 200px; /* Give label decent space */
            flex-grow: 1;
            font-size: 0.9em;
            word-break: break-all; /* Prevent long names overflowing */
            margin-right: 10px; /* Add space between label and button */
        }

        /* Style for the Play button */
        .play-button {
            flex-shrink: 0; /* Prevent button from shrinking */
            background-color: #616161; /* Grey background */
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px; /* Smaller padding */
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 5px; /* Space before slider */
            min-width: 35px; /* Ensure minimum width */
            text-align: center;
        }
        .play-button:hover {
            background-color: #757575;
        }
        .play-button:active {
            background-color: #424242;
        }


        .audio-control input[type="range"] {
            flex-basis: 150px; /* Slider width */
            flex-grow: 2; /* Allow slider to take more space */
            cursor: pointer;
            accent-color: #5c6bc0; /* Match app accent */
        }

        .audio-control .volume-value {
            flex-basis: 30px; /* Space for value display */
            text-align: right;
            font-size: 0.9em;
            color: #bdbdbd; /* Slightly dimmer value */
            min-width: 30px; /* Ensure space */
        }

        /* Style for the Save All button */
        #save-all-button {
            background-color: #5c6bc0; /* Match app accent */
            color: white;
            font-size: 18px;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-top: 20px; /* Space above the button */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #save-all-button:hover {
            background-color: #3f51b5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #save-all-button:active {
            background-color: #303f9f;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }


        #loading-message {
            font-size: 1.2em;
            margin-top: 50px;
        }
         #save-confirmation {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 100;
        }
        #save-confirmation.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1>Sync Key Audio Mixer</h1>
    <div id="loading-message">Loading audio manifests...</div>
    <div id="controlsContainer">
        <!-- Controls will be generated here -->
    </div>

    <!-- Add the Save All button after the controls container -->
    <button id="save-all-button">Save All Settings</button>

    <div id="save-confirmation">Settings Saved!</div>

    <script>
        // Define the keys you have sync audio folders for
        const keys = ["A", "Asharp", "B", "C", "Csharp", "D", "Dsharp", "E", "F", "Fsharp", "G", "Gsharp"];
        const baseAudioPath = './audio/sing-key-audio/'; // Relative path to sing key audio

        const controlsContainer = document.getElementById("controlsContainer");
        const loadingMessage = document.getElementById("loading-message");
        const saveConfirmation = document.getElementById("save-confirmation");
        const saveAllButton = document.getElementById("save-all-button"); // Get the save button
        let saveTimeout;
        let currentTestAudio = null; // Variable to hold the currently playing test audio
        let currentPlayButton = null; // Variable to hold the button that is currently in 'stop' mode

        // --- Updated Function to create UI for a single audio file ---
        // Now takes only the key, as each key has a single merged audio file.
        function createVolumeControl(key) {
            // The audio file for this key is now assumed to be key.mp3
            const audioFileName = `${key}.mp3`;

            // Use a consistent storage key for per-key volume
            const controlId = `volume_sing_key_${key}`;
            const storageKey = controlId; // Use the same ID for localStorage key


            // Load saved volume or default to 1.0
            const savedVolume = parseFloat(localStorage.getItem(storageKey)) || 1.0;

            const control = document.createElement("div");
            control.className = "audio-control";

            const label = document.createElement("label");
            label.htmlFor = controlId; // Associate label with slider
            label.textContent = key.replace("sharp", "#"); // Display the musical key name

            // --- Create Play Button ---
            const playButton = document.createElement("button");
            playButton.textContent = "▶"; // Play symbol
            playButton.className = "play-button";
            playButton.title = `Play/Stop ${audioFileName}`; // Tooltip

            const slider = document.createElement("input"); // Volume slider
            slider.type = "range";
            slider.id = controlId;
            slider.min = "0";
            slider.max = "1";
            slider.step = "0.05"; // Finer control
            slider.value = savedVolume.toFixed(2); // Set initial value
            // --- Add data attributes to slider for saving ---
            slider.dataset.key = key; // Store the key for saving
            // --- End data attributes ---

            const valueDisplay = document.createElement("span");
            valueDisplay.className = "volume-value";
            valueDisplay.textContent = savedVolume.toFixed(2);

            // --- Play Button Event Listener (NEW TOGGLE LOGIC) ---
            playButton.addEventListener("click", () => {
                // If this button is already the active one, stop the audio
                if (currentPlayButton === playButton) {
                    if (currentTestAudio) {
                        currentTestAudio.pause();
                        currentTestAudio.currentTime = 0;
                        currentTestAudio = null;
                    }
                    playButton.textContent = "▶";
                    currentPlayButton = null;
                    return; // Exit
                }

                // If another audio is playing, stop it and reset its button
                if (currentTestAudio) {
                    currentTestAudio.pause();
                    currentTestAudio.currentTime = 0;
                }
                if (currentPlayButton) {
                    currentPlayButton.textContent = "▶";
                }

                // Now, play the new audio
                const audioPath = `${baseAudioPath}${audioFileName}`;
                const currentVolume = parseFloat(slider.value);

                console.log(`Playing test audio for key ${key}: ${audioPath} at volume ${currentVolume}`);

                currentTestAudio = new Audio(audioPath);
                currentTestAudio.volume = currentVolume;
                currentPlayButton = playButton; // Set this button as the active one
                playButton.textContent = "■"; // Change to stop symbol

                currentTestAudio.play().catch(err => {
                    console.error("Error playing test audio:", err);
                    alert(`Error playing sound: ${err.message}`);
                    // Reset on error
                    playButton.textContent = "▶";
                    currentPlayButton = null;
                    currentTestAudio = null;
                });

                // When playback finishes naturally, reset the button
                currentTestAudio.addEventListener('ended', () => {
                    if (currentPlayButton === playButton) { // Only reset if it's still the active one
                        playButton.textContent = "▶";
                        currentPlayButton = null;
                        currentTestAudio = null;
                    }
                });
            });
            // --- End Play Button Listener ---


            // --- Updated Slider Event listener ---
            // Only updates the visual display, does NOT save to localStorage
            slider.addEventListener("input", (e) => {
                const newVolume = parseFloat(e.target.value);
                valueDisplay.textContent = newVolume.toFixed(2);
                // REMOVED: localStorage.setItem(storageKey, newVolume);
                // REMOVED: Save confirmation logic from here
            });
            // --- End Updated Slider Listener ---

            // Append elements in order
            control.appendChild(label);
            control.appendChild(playButton); // Add button after label
            control.appendChild(slider);
            control.appendChild(valueDisplay);

            return control;
        }
        // --- End Updated createVolumeControl ---

        // Main function to build the UI (no changes needed here)
        async function buildMixerUI() {
            // ... (keep existing manifest fetching and UI building loop) ...
             let keysProcessed = 0;
            for (const key of keys) {
                // Assume each key has a single audio file directly in the sing-key-audio folder
                // We don't need to fetch a manifest anymore.
                keysProcessed++;
                const keyGroup = document.createElement("div");
                keyGroup.className = "key-group";
                keyGroup.innerHTML = `<h2>${key.replace("sharp", "#")}</h2>`; // Display '#' nicely

                // Create a single volume control for the merged audio file for this key
                const controlElement = createVolumeControl(key);
                keyGroup.appendChild(controlElement);

                controlsContainer.appendChild(keyGroup);
            }

            // Update loading message based on keys processed
            if (keysProcessed > 0) {
                 loadingMessage.style.display = 'none'; // Hide loading message if successful
                 saveAllButton.style.display = 'block'; // Show save button if controls were loaded
            } else {
                 loadingMessage.textContent = 'Failed to load any audio manifests. Please check console for errors.';
                 loadingMessage.style.color = '#f44336'; // Error color
                 saveAllButton.style.display = 'none'; // Hide save button if nothing loaded
            }
        }

        // --- Event Listener for the Save All Button ---
        saveAllButton.addEventListener('click', () => {
            console.log("Saving all settings...");
            // Select all sliders within the controls container
            const allSliders = controlsContainer.querySelectorAll('input[type="range"]');
            let savedCount = 0;

            allSliders.forEach(slider => {
                // Retrieve key and filename from data attributes
                const key = slider.dataset.key;

                if (key) {
                    const storageKey = `volume_sing_key_${key}`; // Consistent storage key
                    const currentVolume = parseFloat(slider.value);
                    localStorage.setItem(storageKey, currentVolume);
                    savedCount++;
                } else {
                    console.warn("Slider missing 'data-key' attribute:", slider);
                }
            });

            console.log(`Saved ${savedCount} volume settings.`);

            // Show save confirmation briefly
            saveConfirmation.textContent = `Saved ${savedCount} Settings!`; // Update text
            saveConfirmation.classList.add('show');
            clearTimeout(saveTimeout); // Clear previous timeout
            saveTimeout = setTimeout(() => {
                saveConfirmation.classList.remove('show');
            }, 2000); // Hide after 2 seconds
        });
        // --- End Save All Button Listener ---


        // Initialize the UI build process when the DOM is ready
        document.addEventListener('DOMContentLoaded', buildMixerUI);

    </script>
</body>
</html>
