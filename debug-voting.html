<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Voting System</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .debug-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .vote-btn { padding: 15px 25px; margin: 10px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; }
        .like-btn { background: #28a745; color: white; }
        .dislike-btn { background: #dc3545; color: white; }
        .vote-btn:hover { opacity: 0.8; }
        .vote-btn.clicked { box-shadow: 0 0 15px rgba(0,123,255,0.5); }
        .count { font-weight: bold; margin-left: 10px; }
        .debug-log { background: #f1f1f1; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Voting System</h1>
    
    <div class="debug-section">
        <h3>Vote Buttons</h3>
        <button id="like-btn" class="vote-btn like-btn">
            üëç Like <span id="like-count" class="count">0</span>
        </button>
        <button id="dislike-btn" class="vote-btn dislike-btn">
            üëé Dislike <span id="dislike-count" class="count">0</span>
        </button>
    </div>

    <div class="debug-section">
        <h3>Debug Information</h3>
        <div id="status">Loading...</div>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <button onclick="testLocalStorage()">Test LocalStorage</button>
        <button onclick="clearData()">Clear All Data</button>
    </div>

    <div class="debug-section">
        <h3>Debug Log</h3>
        <div id="debug-log" class="debug-log"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCIqEzxusl4VtVfODqTafgAi22U8AkIDbo",
            authDomain: "uncle-ali-piano.firebaseapp.com",
            projectId: "uncle-ali-piano",
            storageBucket: "uncle-ali-piano.firebasestorage.app",
            messagingSenderId: "639101542865",
            appId: "1:639101542865:web:230392d4499bb9f2a8c0f0",
            measurementId: "G-EDCCJMJ96B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, 'feedback', 'pianoFeedback');

        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debug-log');
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Update status
        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? 'red' : 'green';
        }

        // Update vote counts display
        function updateCountDisplay(likes, dislikes) {
            document.getElementById('like-count').textContent = likes;
            document.getElementById('dislike-count').textContent = dislikes;
            debugLog(`Display updated: ${likes} likes, ${dislikes} dislikes`);
        }

        // Test Firebase connection
        window.testFirebaseConnection = async function() {
            try {
                debugLog('Testing Firebase connection...');
                const testDocRef = doc(db, 'test', 'connection');
                await getDoc(testDocRef);
                debugLog('‚úÖ Firebase connection successful!');
                updateStatus('Firebase Connected');
            } catch (error) {
                debugLog(`‚ùå Firebase connection failed: ${error.message}`);
                updateStatus('Firebase Connection Failed', true);
            }
        };

        // Test localStorage
        window.testLocalStorage = function() {
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                debugLog('‚úÖ LocalStorage working!');
                updateStatus('LocalStorage Working');
            } catch (error) {
                debugLog(`‚ùå LocalStorage failed: ${error.message}`);
                updateStatus('LocalStorage Failed', true);
            }
        };

        // Clear all data
        window.clearData = async function() {
            try {
                // Clear localStorage
                localStorage.removeItem('piano_user_vote');
                localStorage.removeItem('piano_likes_count');
                localStorage.removeItem('piano_dislikes_count');
                
                // Reset Firebase data
                await setDoc(docRef, { likes: 0, dislikes: 0, lastUpdated: new Date().toISOString() });
                
                debugLog('‚úÖ All data cleared!');
                updateStatus('Data Cleared');
                updateCountDisplay(0, 0);
                updateButtonStates(null);
            } catch (error) {
                debugLog(`‚ùå Clear data failed: ${error.message}`);
            }
        };

        // Update button states
        function updateButtonStates(currentVote) {
            const likeBtn = document.getElementById('like-btn');
            const dislikeBtn = document.getElementById('dislike-btn');
            
            likeBtn.classList.remove('clicked');
            dislikeBtn.classList.remove('clicked');
            
            if (currentVote === 'like') {
                likeBtn.classList.add('clicked');
            } else if (currentVote === 'dislike') {
                dislikeBtn.classList.add('clicked');
            }
        }

        // Handle vote
        async function handleVote(voteType) {
            try {
                debugLog(`Vote attempted: ${voteType}`);
                
                // Get current vote from localStorage
                const currentVote = localStorage.getItem('piano_user_vote');
                debugLog(`Current user vote: ${currentVote || 'none'}`);
                
                // Determine action
                let action = 'none';
                if (currentVote === null) {
                    action = 'add';
                } else if (currentVote === voteType) {
                    action = 'remove';
                } else {
                    action = 'switch';
                }
                
                debugLog(`Action determined: ${action}`);
                
                // Get current Firebase data
                const docSnap = await getDoc(docRef);
                let newLikes = 0, newDislikes = 0;
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    newLikes = data.likes || 0;
                    newDislikes = data.dislikes || 0;
                    debugLog(`Current Firebase data: ${newLikes} likes, ${newDislikes} dislikes`);
                } else {
                    debugLog('No Firebase document exists, creating new one');
                }
                
                // Apply action
                if (action === 'add') {
                    if (voteType === 'like') newLikes++;
                    else newDislikes++;
                } else if (action === 'switch') {
                    if (voteType === 'like') {
                        newLikes++;
                        newDislikes = Math.max(0, newDislikes - 1);
                    } else {
                        newDislikes++;
                        newLikes = Math.max(0, newLikes - 1);
                    }
                } else if (action === 'remove') {
                    if (voteType === 'like') {
                        newLikes = Math.max(0, newLikes - 1);
                    } else {
                        newDislikes = Math.max(0, newDislikes - 1);
                    }
                }
                
                debugLog(`New counts calculated: ${newLikes} likes, ${newDislikes} dislikes`);
                
                // Update Firebase
                await setDoc(docRef, {
                    likes: newLikes,
                    dislikes: newDislikes,
                    lastUpdated: new Date().toISOString()
                });
                
                debugLog('‚úÖ Firebase updated successfully');
                
                // Update localStorage
                if (action === 'remove') {
                    localStorage.removeItem('piano_user_vote');
                } else {
                    localStorage.setItem('piano_user_vote', voteType);
                }
                
                // Update UI
                updateCountDisplay(newLikes, newDislikes);
                updateButtonStates(action === 'remove' ? null : voteType);
                updateStatus(`Vote ${action}: ${voteType}`);
                
            } catch (error) {
                debugLog(`‚ùå Vote failed: ${error.message}`);
                updateStatus(`Vote Failed: ${error.message}`, true);
            }
        }

        // Initialize
        async function init() {
            debugLog('üöÄ Initializing debug voting system...');
            
            // Add event listeners
            document.getElementById('like-btn').addEventListener('click', () => handleVote('like'));
            document.getElementById('dislike-btn').addEventListener('click', () => handleVote('dislike'));
            
            // Test Firebase connection
            await testFirebaseConnection();
            
            // Load initial data
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateCountDisplay(data.likes || 0, data.dislikes || 0);
                    debugLog(`Loaded initial data: ${data.likes || 0} likes, ${data.dislikes || 0} dislikes`);
                } else {
                    debugLog('No initial data found');
                }
                
                // Load user's current vote
                const currentVote = localStorage.getItem('piano_user_vote');
                updateButtonStates(currentVote);
                debugLog(`User's current vote: ${currentVote || 'none'}`);
                
            } catch (error) {
                debugLog(`‚ùå Failed to load initial data: ${error.message}`);
            }
            
            // Set up real-time listener
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    updateCountDisplay(data.likes || 0, data.dislikes || 0);
                    debugLog(`üì° Real-time update: ${data.likes || 0} likes, ${data.dislikes || 0} dislikes`);
                }
            });
            
            debugLog('‚úÖ Initialization complete');
            updateStatus('System Ready');
        }

        // Start initialization
        init();
    </script>
</body>
</html>